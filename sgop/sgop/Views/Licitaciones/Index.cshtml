@model  List<sgop.Models.ViewModels.ListarLicitaciones>
@{
    ViewBag.Title = "Licitaciones";
}
<div class="container-fluid" style="margin-top: 2%">
    <div class="card border border-0 p-0 h-100">

        <div class="container-fluid w-75 p-0" style="margin-top: 5%">
            <!--Inicia el container del card-->
            <div class="col-12">
                <div class="card border border-0 p-0 h-100">
                    <!--Inicia el card-->
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="card-header bg-dark">
                        <!--Inicia la cabecera del card-->
                        <form method="post" action="#" id="buscarLicitaciones">
                            <!---------------------------------------------------------------------------------------------------------------->
                            <div class="row">
                                <!--Inician los campos del primer renglon-->
                                <div class="col-4">
                                    <div class="input-group input-group-sm">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">Licitacion</span>
                                        </div>
                                        <input type="text" class="form-control busque" name="noLicitacion" id="_noLicitacion">
                                        <!--Tabla licitaciones -> campo noLicitacion-->
                                    </div>
                                </div>
                                <!---------------------------------------------------------------------------------------------------------------->
                                <div class="col-4">
                                    <select name="idMunicipio" class="custom-select custom-select-sm busque select" id="idMunicipio">
                                        <option selected value="0">MUNICIPIOS</option>
                                        @foreach (var item in ViewBag.listMunicipios)
                                        {
                                            <option value="@item.idMunicipio">@item.descripcion</option><!--value=idMunicipio, descripcion reemplaza "Municipio 1"-->
                                        }
                                    </select>
                                    <!--Se llena con base en una consulta a la tabla de catalogoMunicipios-->
                                    <!--Tabla licitaciones -> campo idMunicipio-->
                                </div>
                                <!---------------------------------------------------------------------------------------------------------------->
                                <div class="col-2">
                                    <div class="input-group input-group-sm">
                                        <select name="idEstatus" id="idEstatus" class="custom-select custom-select-sm busque select">
                                            <option selected value="0">TODOS</option>
                                            @foreach (var item in ViewBag.listarEstatus)
                                            {
                                                <option value="@item.idEstatus">@item.descripcion</option><!--value=idMunicipio, descripcion reemplaza "Municipio 1"-->
                                            }
                                        </select>
                                        <!--Tabla licitaciones -> campo fechaModificacion usando between-->
                                    </div>
                                </div>
                                <!---------------------------------------------------------------------------------------------------------------->
                                <div class="col-2">
                                    <button type="button" class="btn btn-outline-success w-100 btn-sm" data-toggle="modal" data-target="#modalCrearLicitacion">Nuevo</button>
                                </div>
                            </div><!--Termina el primer renglon de campos-->
                            <!---------------------------------------------------------------------------------------------------------------->
                            <!---------------------------------------------------------------------------------------------------------------->
                        </form><!--Termina el formulario para la busqueda de licitaciones-->
                    </div><!--Termina la cabecera del card-->
                </div>
            </div>
        </div>





        <div class="card-body" id="card-body">

            <!--Aqui va la consulta de las licitaciones-->
            <table class="table table-striped table-responsive-xl">
                <thead>
                    <tr>
                        <th>Id Licitacion</th>
                        <th>Nombre de licitacion</th>
                        <th>Nombre</th>
                        <th>Municipio</th>
                        <th>Estatus</th>
                        <th>Empresa</th>
                        <th>Colonia</th>
                        <th>Fecha Creacion</th>

                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var oElemento in Model)
                    {

                        <tr>
                            <input type="hidden" name="id_Licitacion" value="@oElemento.idLicitacion" />
                            <td>@oElemento.idLicitacion</td>
                            <td>@oElemento.noLicitacion</td>
                            <td>@oElemento.nombreObra</td>
                            <td>@oElemento.descripcion_muni</td>
                            <td>@oElemento.descripcion_estatus</td>
                            <td>@oElemento.descripcion_empresa</td>
                            <td>@oElemento.localidad</td>
                            <td>@oElemento.fechaCreacion</td>

                            <td>


                                @if (@oElemento.idEstatus == 2)
                                {
                                    using (Html.BeginForm("Visualizar_Licitacion", "Licitaciones", FormMethod.Post))
                                    {
                                        <input type="hidden" name="id_Licitacion" value="@oElemento.idLicitacion" />
                                        <button class="btn btn-outline-success" id="Visualizar_Licitacion" value="@oElemento.idLicitacion">Visualizar</button>
                                    }
                                }
                                else if (@oElemento.idEstatus == 3)
                                {
                                    using (Html.BeginForm("Visualizar_Licitacion", "Licitaciones", FormMethod.Post))
                                    {
                                        <input type="hidden" name="id_Licitacion" value="@oElemento.idLicitacion" />
                                        <button class="btn btn-outline-success" id="Visualizar_Licitacion" value="@oElemento.idLicitacion">Visualizar</button>
                                    }
                                }
                                else if (@oElemento.idEstatus == 1)
                                {
                                    using (Html.BeginForm("Editar_Licitacion", "Licitaciones", FormMethod.Post))
                                    {
                                        <input type="hidden" name="id_Licitacion" value="@oElemento.idLicitacion" />
                                        <button class="btn btn-outline-success" id="editarLicitacion" value="@oElemento.idLicitacion">Editar</button>
                                    }
                                }




                            </td>
                        </tr>

                    }
                </tbody>
            </table>

        </div>
    </div><!--Termina el card de los datos-->
</div><!--Termina el espacio para meter todo el container-->

<div class="modal fade" id="modalCrearLicitacion">
    <!--Inicia el modal con los campos para la creacion de la licitacion-->
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border border-0">
            <!---------------------------------------------------------------------------------------------------------------->
            <div class="modal-header bg-dark">
                <!--Inicia la cabecera del modal-->
                <h4 class="modal-title text-muted">Nueva de licitacion</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!---------------------------------------------------------------------------------------------------------------->
            @using (Html.BeginForm("crearLicitacion", "Licitaciones", FormMethod.Post, new { @id = "crearLicitacion" }))
            {
                @Html.AntiForgeryToken()

                <div class="modal-body">
                    <div class="row">
                        <div class="col-10 mx-auto my-1">
                            <input type="text" class="form-control form-control-sm" name="noLicitacion" placeholder="Numero de Licitacion">
                            <!--Tabla licitaciones -> campo noLicitacion. Limitar a 30 caracteres-->
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-10  mx-auto my-1">
                            <select name="idMunicipio" class="custom-select custom-select-sm">
                                <option selected disabled>Municipio</option>
                                @foreach (var item in ViewBag.listMunicipios)
                                {
                                    <option value="@item.idMunicipio">@item.descripcion</option><!--value=idMunicipio, descripcion reemplaza "Municipio 1"-->
                                }
                            </select>
                            <!--Se llena con base en una consulta a la tabla de catalogoMunicipios-->
                            <!--Tabla licitaciones -> campo idMunicipio-->
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-10  mx-auto my-1">
                            <select name="idEmpresa" class="custom-select custom-select-sm">
                                <option selected disabled>Empresa</option>
                                @foreach (var item in ViewBag.listarEmpresas)
                                {
                                    <option value="@item.idEmpresa">@item.razonSocial</option><!--value=idMunicipio, descripcion reemplaza "Municipio 1"-->
                                }
                            </select>
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-10 mx-auto my-1">
                            <input type="text" class="form-control form-control-sm" name="localidad" placeholder="Localidad">
                            <!--Tabla licitaciones -> campo localidad. Limitar a 50 caracteres-->
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-10 mx-auto my-1">
                            <textarea class="form-control form-control-sm" rows="5" name="nombreObra" placeholder="Nombre de la obra"></textarea>
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-10 mx-auto my-1">
                            <input type="text" class="form-control form-control-sm" name="fechaVisita" onfocus="(this.type='date')" placeholder="Fecha Visita" data-toggle="tooltip" title="Fecha Visita" data-placement="left">
                            <!--Tabla licitaciones -> campo fechaVisita. Validar que la fecha no sea menor a la actual-->
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-10 mx-auto my-1">
                            <input type="text" class="form-control form-control-sm" name="fechaAclaraciones" onfocus="(this.type='date')" placeholder="Fecha Aclaraciones" data-toggle="tooltip" title="Fecha Aclaraciones" data-placement="left">
                            <!--Tabla licitaciones -> campo fechaAclaraciones. Validar que la fecha no sea menor a la actual o a fechaVisita-->
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-10 mx-auto my-1">
                            <input type="text" class="form-control form-control-sm" name="fechaPropuesta" onfocus="(this.type='date')" placeholder="Fecha Propuesta" data-toggle="tooltip" title="Fecha Propuesta" data-placement="left">
                            <!--Tabla licitaciones -> campo fechaPropuesta. Validar que la fecha no sea menor a la actual o a fechaVisita o fechaAclaraciones-->
                        </div>
                    </div>
                    <!---------------------------------------------------------------------------------------------------------------->
                    <div class="row">
                        <div class="col-10 mx-auto my-1">
                            <input type="text" class="form-control form-control-sm" name="fechaFallo" onfocus="(this.type='date')" placeholder="Fecha Fallo" data-toggle="tooltip" title="Fecha Fallo" data-placement="left">
                            <!--Tabla licitaciones -> campo fechaFallo. Validar que la fecha no sea menor a la actual o a fechaVisita o fechaAclaraciones o fechaPropuesta-->
                        </div>
                    </div>

                </div>
                <!---------------------------------------------------------------------------------------------------------------->
                <div class="modal-footer">
                    <button type="submit" class="btn btn-outline-primary w-100 btn-sm">Guardar</button>
                    <!--Boton que hace el submit del formulario crearLicitacion, primeramente validando todos los campos-->
                    <button type="button" class="btn btn-outline-danger w-100 btn-sm" data-dismiss="modal">Cancelar</button>
                    <!--Boton que limpia los campos y cierra el modal-->
                </div>
            }
            <!---------------------------------------------------------------------------------------------------------------->
        </div>
    </div>
</div><!--Termina el modal con los campos para la creacion de la licitacion-->
<!---------------------------------------------------------------------------------------------------------------->

@section scripts{
    <script>
        //Script para que aparezcan los tooltips en los campos date
        $(document).ready(function () {
            //LLenar Licitacion
            $('[data-toggle="tooltip"]').tooltip();
            $("#crearLicitacion").submit(function (e) {
                e.preventDefault();
                url = "@Url.Content("~/Licitaciones/crearLicitacion")";
                parametros = $(this).serialize();
                $.post(url, parametros, function (data) {
                    if (data.a == true) {
                        Swal.fire({
                            icon: 'success',
                            text: 'Se ha guardado Exitosamente',
                        })
                        window.location.href = "@Url.Content("~/Licitaciones")";
                    }
                });
            });
            //Editar Licitacion
            $("#Editar_Licitacion").submit(function (e) {
                e.preventDefault();
                url = "@Url.Content("~/Licitaciones/Editar_Licitacion")";
                parametros = $(this).serialize();
                $.post(url, parametros, function (data) {
                    if (data.a == true) {
                        alert(data.b);
                    }
                });
            });
                //Visualizar
            $("#Visualizar_Licitacion").submit(function (e) {
                e.preventDefault();
                url = "@Url.Content("~/Licitaciones/Visualizar_Licitacion")";
                parametros = $(this).serialize();
                $.post(url, parametros, function (data) {
                    if (data.a == true) {
                        alert(data.b);
                    }
                });
            });
        });
    </script>
}

